<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
   <meta name="microphone" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat App Clone ‚Äî Fixed</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; }
    #app { display: flex; height: 100vh; flex-direction: column; }
    .navbar { background-color: #244576; color: white; display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: relative; z-index: 1000; }
    .navbar-title { font-weight: bold; font-size: 1.3rem; }
    .navbar-icons span { margin-left: 20px; cursor: pointer; font-size: 1.3rem; user-select: none; color: white; transition: color 0.2s ease; }
    .navbar-icons span:hover { color: #a9c0e7; }
    .navbar-search { flex: 1; margin-left: 15px; }
    .navbar-search input { width: 100%; padding: 7px 10px; border-radius: 20px; border: none; outline: none; font-size: 1rem; }
    #main-content { flex: 1; display: flex; height: calc(100vh - 52px); }
    .contacts { width: 30%; min-width: 220px; background: #f0f0f0; display: flex; flex-direction: column; border-right: 1px solid #ccc; position: relative; }
    footer { position: fixed; bottom: 0; left: 0; width: 30%; max-width: 100%; background-color: #f1f1f1; display: flex; justify-content: center; align-items: center; padding: 10px; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1000; }
    .new-chat button { width: 40%; padding: 10px; background: #244576; color: #fff; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; box-shadow: 3px 3px 3px #030507; margin-right: 180px; }
    .contact-list { overflow-y: auto; flex: 1; margin-top: 10px; padding: 0 10px; }
    .contact { padding: 15px; border-bottom: 1px solid #ddd; cursor: pointer; user-select: none; }
    .contact:hover { background: #ddd; }
    .chat { flex: 1; display: none; flex-direction: column; }
    .chat-header { background: #244576; color: #fff; padding: 15px; display: flex; align-items: center; }
    .chat-header button { background: transparent; border: none; color: white; padding-bottom: 5px; font-size: 18px; margin-right: 20px; cursor: pointer; box-shadow: 0px 0px 3px #030507; }
    .messages { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; }
    .message { max-width: 60%; margin-bottom: 10px; padding: 10px; border-radius: 15px; clear: both; display: flex; align-items: flex-start; }
    .sent { background: #244576; color: white; margin-left: auto; }
    .received { background: #e5e5ea; color: black; margin-right: auto; }
    .profile-pic { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .message-content { flex: 1; }
    .timestamp { font-size: 11px; color: grey; margin-top: 5px; text-align: right; }
    .input-area { display: flex; padding: 10px; border-top: 1px solid #ccc; background: #fff; }
    input[type="text"] { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; outline: none; box-shadow: 3px 3px 3px #030507; }
    button.send-button { margin-left: 10px; background: #244576; color: white; border: none; border-radius: 20px; padding: 10px 15px; cursor: pointer; box-shadow: 0px 0px 3px #030507; }
    #new-chat-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; z-index: 999; }
    .modal-backdrop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0.9; }
    .modal { background: white; padding: 20px; border-radius: 10px; z-index: 1000; width: 90%; max-width: 300px; position: relative; box-shadow: 0px 3px 5px #244576; color: white; }
    .modal h3 { margin: 0 0 10px 0; }
    .modal input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px; outline: none; font-size: 1rem; color: black; }
    .modal-buttons { text-align: right; }
    .modal-buttons button { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px; font-weight: bold; }
    .modal-buttons .cancel { background: #aaa; color: white; }
    .modal-buttons .add { background: #244576; color: white; }
    .menu-dropdown { display: none; position: absolute; right: 10px; top: 50px; background-color: white; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
    .menu-dropdown.show { display: block; }
    .menu-dropdown a { display: block; padding: 10px 15px; text-decoration: none; color: #333; }
    .menu-dropdown a:hover { background-color: #f5f5f5; }
    @media (max-width: 600px) { .contacts { width: 100%; } .chat { position: absolute; top: 0; bottom: 0; width: 100%; background: white; z-index: 100; } footer { width: 100%; max-width: 100%; } }.status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: 8px; }
.status-indicator.online { background-color: #4CAF50; }
.status-indicator.offline { background-color: #ccc; }

/* FIX: CSS comments must use block syntax, not // */
.modal-buttons .add.loading { position: relative; color: transparent; }
.modal-buttons .add.loading::after { content: ""; position: absolute; width: 16px; height: 16px; top: 50%; left: 50%; margin: -8px 0 0 -8px; border: 2px solid transparent; border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.context-menu { display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); z-index: 1000; width: 120px; }
.menu-item { padding: 8px 12px; cursor: pointer; user-select: none; }
.menu-item:hover { background: #f0f0f0; }
  
  .message-sender {
  font-size: 0.85em; /* smaller than normal text */
  font-weight: bold;
  color: #444; /* optional softer color */
}
/* Recording button styles */
.record-button {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  margin-right: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.record-button:hover {
  background: #c82333;
  transform: scale(1.1);
}

.record-button.recording {
  background: #28a745;
  animation: pulse 1.5s infinite;
}

/* Recording indicator */
.recording-indicator {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(220, 53, 69, 0.9);
  color: white;
  padding: 15px 20px;
  border-radius: 25px;
  display: none;
  align-items: center;
  gap: 10px;
  z-index: 1000;
  cursor: pointer;
}

.recording-pulse {
  width: 12px;
  height: 12px;
  background: #fff;
  border-radius: 50%;
  animation: recordingPulse 1s infinite;
}

/* Audio message styling */
.audio-message {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 15px;
  background: #e9ecef;
  border-radius: 20px;
  margin: 10px 0;
}

.audio-player {
  flex: 1;
  height: 40px;
}

.audio-duration {
  font-size: 12px;
  color: #6c757d;
}

/* Animations */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

@keyframes recordingPulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
  </style>
</head>
<body>
  <div class="navbar" id="navbar">
    <span class="navbar-title">ChatApp</span>
    <div class="navbar-search" id="navbar-search" style="display:none;">
      <input type="text" id="search-input" placeholder="Search contacts..." />
      <button onclick="closeSearchIfOpen()" style="background: none; border: none; color: white; margin-left: 5px; cursor: pointer;">X</button>
    </div>
    <div class="navbar-icons" id="navbar-icons">
      <span title="Search" onclick="toggleSearch()"><i class="fas fa-search"></i></span>
      <span title="Menu" onclick="toggleMenu()"><i class="fas fa-ellipsis-v"></i></span>
    </div>
    <div class="menu-dropdown" id="menu-dropdown">
      <a href="settings.html">Settings</a>
      <a href="#">Profile</a>
      <a href="#" id="logout">Logout</a>
    </div>
  </div>
  <div id="main-content">
    <div class="contacts" id="contacts">
      <footer class="new-chat">
        <button onclick="openModal()">+ New Chat</button>
      </footer>
      <div class="contact-list" id="contact-list"></div>
    </div>
    <div class="chat" id="chat">
      <div class="chat-header">
        <button onclick="goBack()">‚Üê</button>
        <span id="chat-name">Chat</span>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input type="text" id="message-input" placeholder="Type a message..." />
        <button class="send-button" onclick="sendMessage()">Send</button>
             </div>
    </div>
  </div> 
  <div id="new-chat-modal">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal">
      <h3>Add New Contact</h3>
      <input type="text" id="new-chat-name" placeholder="Enter name..." />
      <div class="modal-buttons">
        <button class="cancel" onclick="closeModal()">Cancel</button>
        <button class="add" onclick="createChat()">Add</button>
      </div>
    </div>
  </div> 
  <div id="context-menu" class="context-menu">
    <div class="menu-item" onclick="replyToMessage()">Reply</div>
    <div class="menu-item" onclick="likeMessage()">Like ‚ù§Ô∏è</div>
    <div class="menu-item" onclick="deleteMessage()">Delete üóëÔ∏è</div>
  </div>  <!-- Firebase --> 
  
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>  <script>
  // Firebase configuration and initialization
  const firebaseConfig = {
    apiKey: "AIzaSyBEfkHrGJR82b-Ztdeyq0yURgv5d7UVhrc",
    authDomain: "chattapp-b2abe.firebaseapp.com",
    databaseURL: "https://chattapp-b2abe-default-rtdb.firebaseio.com",
    projectId: "chattapp-b2abe",
    storageBucket: "chattapp-b2abe.firebasestorage.app",
    messagingSenderId: "479823967484",
    appId: "1:479823967484:web:f8ce65ef5e20aa43aad379",
    measurementId: "G-S4J69CW2LJ"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // Global variables
  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null;
  let loadedMessages = []; // FIX: really global for context menu helpers

  // Database repair function (optional)
  async function repairDatabase() {
    try {
      const updates = {};
      const [userChatsSnap, usersSnap] = await Promise.all([
        database.ref('userChats').once('value'),
        database.ref('users').once('value')
      ]);

      userChatsSnap.forEach(userNode => {
        userNode.forEach(contactNode => {
          const path = `userChats/${userNode.key}/${contactNode.key}`;
          updates[`${path}/contactId`] = contactNode.key;
          updates[`${path}/contactName`] = contactNode.child('displayName').val() || contactNode.child('Displayname').val() || 'Unknown';
          updates[`${path}/timestamp`] = firebase.database.ServerValue.TIMESTAMP;
          const userData = usersSnap.child(userNode.key).val();
          if (userData) {
            updates[`userChats/${contactNode.key}/${userNode.key}`] = {
              contactId: userNode.key,
              contactName: userData.displayName || userData.email,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            };
          }
        });
      });

      if (Object.keys(updates).length) {
        await database.ref().update(updates);
      }
      localStorage.setItem('dbRepaired', 'true');
      return true;
    } catch (e) {
      console.error('Database repair failed:', e);
      return false;
    }
  }

  // Auth state
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      if (!localStorage.getItem('dbRepaired')) { await repairDatabase(); }
      loadContacts();
      setupPresence();
    } else {
      window.location.href = 'login.html';
    }
  });

  // Presence
  function setupPresence() {
    const userStatusRef = database.ref(`status/${currentUser.uid}`);
    const connectedRef = database.ref('.info/connected');
    connectedRef.on('value', (snap) => {
      if (snap.val() === true) {
        userStatusRef.onDisconnect().set({ status: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP }).then(() => {
          userStatusRef.set({ status: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP });
        });
      }
    });
  }

  // Contacts
  function loadContacts() {
    const contactList = document.getElementById('contact-list');
    contactList.innerHTML = '';
    database.ref(`userChats/${currentUser.uid}`).on('value', snapshot => {
      contactList.innerHTML = '';
      snapshot.forEach(contact => {
        const contactData = contact.val();
        const contactEl = document.createElement('div');
        contactEl.className = 'contact';
        contactEl.innerHTML = `${contactData.contactName} <span class="status-indicator offline" title="Offline"></span>`;

        // live status
        database.ref(`status/${contact.key}/status`).on('value', statusSnap => {
          const status = statusSnap.val() || 'offline';
          const indicator = contactEl.querySelector('.status-indicator');
          indicator.classList.toggle('online', status === 'online');
          indicator.classList.toggle('offline', status !== 'online');
          indicator.title = status === 'online' ? 'Online' : 'Offline';
        });

        contactEl.onclick = () => openChat(contactData.contactName, contact.key);
        contactList.appendChild(contactEl);
      });
    });
  }

  // Open chat
  function openChat(contactName, contactId = 'you_chat') {
    currentChatUser = contactName;
    currentChatId = contactId;
    document.getElementById('chat-name').textContent = contactName;

    document.getElementById('chat').style.display = 'flex';
    document.getElementById('contacts').style.display = 'none';
    if (window.innerWidth <= 600) { document.getElementById('navbar').style.display = 'none'; }

    const messagesContainer = document.getElementById('messages');
    messagesContainer.innerHTML = '';

    const chatId = [currentUser.uid, contactId].sort().join('_');

    database.ref(`chats/${chatId}`).orderByChild('timestamp').on('value', snapshot => {
      messagesContainer.innerHTML = '';
      loadedMessages = []; // reset global cache

      snapshot.forEach(messageSnapshot => {
        const m = messageSnapshot.val() || {};
        // ensure every message has an id we can use for delete/context menu
        const message = { id: m.id || messageSnapshot.key, ...m };
        loadedMessages.push(message);
        displayMessage(message, message.senderId === currentUser.uid);
      });

      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
  }

  // Send message ‚Äî FIX: define key first, then use it
  function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const text = messageInput.value.trim();
    if (!text || !currentChatId) return;

    const chatId = [currentUser.uid, currentChatId].sort().join('_');
    const newMessageKey = database.ref(`chats/${chatId}`).push().key; // FIX order

    const messageData = {
      id: newMessageKey,
      text,
      senderId: currentUser.uid,
      senderName: currentUser.displayName || currentUser.email,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    const updates = {};
    updates[`chats/${chatId}/${newMessageKey}`] = messageData;
    updates[`userChats/${currentUser.uid}/${currentChatId}/lastMessage`] = { text, timestamp: messageData.timestamp };
    updates[`userChats/${currentChatId}/${currentUser.uid}/lastMessage`] = { text, timestamp: messageData.timestamp };

    database.ref().update(updates)
      .then(() => { messageInput.value = ''; })
      .catch(error => { console.error('Error sending message:', error); });
  }

  // UI helpers
  function displayMessage(message, isSent) {
    const messagesContainer = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    messageDiv.dataset.messageId = message.id || message.timestamp;

    if (!isSent) {
        const profilePic = document.createElement('img');
        profilePic.className = 'profile-pic';
        profilePic.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(message.senderName || 'U')}&background=244576&color=fff`;
        messageDiv.appendChild(profilePic);
    }

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    const displayName = isSent ? 'You' : (message.senderName || 'User');
    contentDiv.innerHTML = `${!isSent ? `<div class="message-sender">${displayName}</div>` : ''}
      <div>${message.text || ''}</div>
      <div class="timestamp">${formatTimestamp(message.timestamp)}</div>`;

    messageDiv.appendChild(contentDiv);
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
  function formatTimestamp(timestamp) {
    if (!timestamp) return 'Just now';
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  async function createChat() {
    const emailInput = document.getElementById('new-chat-name');
    const email = emailInput.value.trim().toLowerCase();
    if (!email) { alert('Please enter an email address.'); return; }

    const addBtn = document.querySelector('.modal-buttons .add');
    addBtn.disabled = true; addBtn.classList.add('loading'); addBtn.textContent = '';

    try {
      if (!currentUser || !currentUser.uid) throw new Error('You must be logged in to add a contact.');

      const snapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
      if (!snapshot.exists()) throw new Error(`User with email "${email}" not found. They may need to complete registration.`);

      let contactData = null; let contactId = null;
      snapshot.forEach(childSnapshot => { contactId = childSnapshot.key; contactData = childSnapshot.val(); });
      if (!contactData || !contactId) throw new Error('Could not retrieve contact details.');
      if (contactId === currentUser.uid) throw new Error('You cannot add yourself as a contact.');

      const existingChatSnap = await database.ref(`userChats/${currentUser.uid}/${contactId}`).once('value');
      if (existingChatSnap.exists()) throw new Error(`${contactData.displayName || contactData.email} is already in your contacts!`);

      const timestamp = firebase.database.ServerValue.TIMESTAMP;
      const updates = {};
      updates[`userChats/${currentUser.uid}/${contactId}`] = { contactId, contactName: contactData.displayName || contactData.email, timestamp };
      updates[`userChats/${contactId}/${currentUser.uid}`] = { contactId: currentUser.uid, contactName: currentUser.displayName || currentUser.email, timestamp };
      await database.ref().update(updates);

      alert(`Added ${contactData.displayName || contactData.email} to your contacts!`);
      closeModal();
      loadContacts();
    } catch (error) {
      console.error('Chat creation error:', error);
      alert(error.message);
    } finally {
      addBtn.disabled = false; addBtn.classList.remove('loading'); addBtn.textContent = 'Add';
    }
  }

  function goBack() {
    document.getElementById('chat').style.display = 'none';
    document.getElementById('contacts').style.display = 'flex';
    if (window.innerWidth <= 600) document.getElementById('navbar').style.display = 'flex';
    closeSearchIfOpen();
    closeMenu();
  }

  function toggleSearch() {
    const navbarSearch = document.getElementById('navbar-search');
    const navbarIcons = document.getElementById('navbar-icons');
    if (navbarSearch.style.display === 'none' || navbarSearch.style.display === '') {
      navbarSearch.style.display = 'flex';
      navbarIcons.style.display = 'none';
      document.getElementById('search-input').focus();
      closeMenu();
    } else { closeSearchIfOpen(); }
  }

  function closeSearchIfOpen() {
    const navbarSearch = document.getElementById('navbar-search');
    const navbarIcons = document.getElementById('navbar-icons');
    navbarSearch.style.display = 'none';
    navbarIcons.style.display = 'flex';
    const si = document.getElementById('search-input');
    si.value = '';
    filterContacts();
  }

  function filterContacts() {
    const filter = (document.getElementById('search-input').value || '').toLowerCase();
    const contacts = document.querySelectorAll('.contact-list .contact');
    contacts.forEach(contact => {
      const text = contact.textContent.toLowerCase();
      contact.style.display = text.includes(filter) ? '' : 'none';
    });
  }

  function toggleMenu() { document.getElementById('menu-dropdown').classList.toggle('show'); closeSearchIfOpen(); }
  function closeMenu() { document.getElementById('menu-dropdown').classList.remove('show'); }
  function openModal() { document.getElementById('new-chat-modal').style.display = 'flex'; document.getElementById('new-chat-name').value=''; document.getElementById('new-chat-name').focus(); closeMenu(); }
  function closeModal() { document.getElementById('new-chat-modal').style.display = 'none'; }

  // Events
  document.getElementById('logout').addEventListener('click', () => auth.signOut());
  document.getElementById('search-input').addEventListener('input', filterContacts);
  document.getElementById('message-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

  // Long-press context menu
  let pressTimer; let selectedMessageId = null;
  const messagesEl = document.getElementById('messages');
  messagesEl.addEventListener('mousedown', handlePressStart);
  messagesEl.addEventListener('touchstart', handlePressStart);
  messagesEl.addEventListener('mouseup', () => clearTimeout(pressTimer));
  messagesEl.addEventListener('touchend', () => clearTimeout(pressTimer));
  document.addEventListener('click', (e) => { if (!e.target.closest('.context-menu')) hideContextMenu(); });

  function handlePressStart(e) {
    const target = e.touches ? document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY) : e.target;
    const messageElement = target.closest('.message');
    if (!messageElement) return;
    pressTimer = setTimeout(() => { showContextMenu(e, messageElement.dataset.messageId); e.preventDefault(); }, 500);
  }

  function showContextMenu(e, messageId) {
    const menu = document.getElementById('context-menu');
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const y = e.touches ? e.touches[0].clientY : e.clientY;
    menu.style.display = 'block';
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;
    selectedMessageId = messageId;
    e.preventDefault();
  }
  function hideContextMenu() { document.getElementById('context-menu').style.display = 'none'; selectedMessageId = null; }

  function replyToMessage() { const message = getMessageById(selectedMessageId); alert(`Replying to: "${(message && message.text) || ''}"`); hideContextMenu(); }
  function likeMessage() { const message = getMessageById(selectedMessageId); alert(`Liked: "${(message && message.text) || ''}"`); hideContextMenu(); }
  function deleteMessage() {
    if (!selectedMessageId) return; if (!confirm('Delete this message?')) { hideContextMenu(); return; }
    const chatId = [currentUser.uid, currentChatId].sort().join('_');
    database.ref(`chats/${chatId}/${selectedMessageId}`).remove().then(() => alert('Message deleted!')).catch((error) => alert('Error deleting: ' + error));
    hideContextMenu();
  }
  function getMessageById(messageId) { return loadedMessages.find(msg => (msg.id || msg.timestamp) === messageId) || null; }
  
  
  // Audio recording variables
/*let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let audioBlob = null;

// Initialize voice recording
function initVoiceRecording() {
  const recordBtn = document.getElementById('record-btn');
  const recordingIndicator = document.getElementById('recording-indicator');
  
  recordBtn.addEventListener('click', toggleRecording);
  recordingIndicator.addEventListener('click', stopRecording);
}

// Toggle recording
async function toggleRecording() {
  if (isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
}

// Start recording
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      } 
    });
    
    mediaRecorder = new MediaRecorder(stream, {
      mimeType: 'audio/webm;codecs=opus'
    });
    
    audioChunks = [];
    
    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        audioChunks.push(event.data);
      }
    };
    
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      showAudioPreview(audioBlob);
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    isRecording = true;
    
    // Update UI
    document.getElementById('record-btn').classList.add('recording');
    document.getElementById('recording-indicator').style.display = 'flex';
    
  } catch (error) {
    console.error('Error starting recording:', error);
    alert('Microphone access denied or not available');
  }
}

// Stop recording
function stopRecording() {
  if (mediaRecorder && isRecording) {
    mediaRecorder.stop();
    isRecording = false;
    
    // Update UI
    document.getElementById('record-btn').classList.remove('recording');
    document.getElementById('recording-indicator').style.display = 'none';
  }
}

// Show audio preview before sending
function showAudioPreview(blob) {
  const audioUrl = URL.createObjectURL(blob);
  const audioPlayer = document.getElementById('audio-player');
  
  audioPlayer.src = audioUrl;
  audioPlayer.style.display = 'block';
  
  // Create preview UI
  const previewHtml = `
    <div class="audio-preview">
      <audio controls src="${audioUrl}"></audio>
      <button onclick="sendAudioMessage()" class="send-audio-btn">Send</button>
      <button onclick="cancelAudio()" class="cancel-audio-btn">Cancel</button>
    </div>
  `;
  
  // Add preview to messages area temporarily
  const messagesContainer = document.getElementById('messages');
  messagesContainer.innerHTML += previewHtml;
}

// Send audio message
async function sendAudioMessage() {
  if (!audioBlob) return;
  
  try {
    // Convert blob to base64 for Firebase storage
    const reader = new FileReader();
    reader.readAsDataURL(audioBlob);
    
    reader.onloadend = async () => {
      const base64Audio = reader.result;
      const chatId = [currentUser.uid, currentChatId].sort().join('_');
      
      // Upload to Firebase (you might want to use Firebase Storage instead)
      const messageData = {
        type: 'audio',
        audioData: base64Audio,
        senderId: currentUser.uid,
        senderName: currentUser.displayName || "You",
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        duration: await getAudioDuration(audioBlob)
      };
      
      database.ref(`chats/${chatId}`).push(messageData)
        .then(() => {
          cleanupAudio();
          updateLastMessage("üé§ Voice message");
        });
    };
    
  } catch (error) {
    console.error('Error sending audio:', error);
  }
}

// Get audio duration
async function getAudioDuration(blob) {
  return new Promise((resolve) => {
    const audio = new Audio();
    audio.src = URL.createObjectURL(blob);
    audio.onloadedmetadata = () => {
      resolve(Math.round(audio.duration));
    };
  });
}

// Cancel audio recording
function cancelAudio() {
  cleanupAudio();
}

// Clean up audio resources
function cleanupAudio() {
  audioBlob = null;
  audioChunks = [];
  document.getElementById('audio-player').style.display = 'none';
  document.querySelector('.audio-preview')?.remove();
}

// Display audio messages
function displayAudioMessage(message, isSent) {
  const messagesContainer = document.getElementById('messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSent ? 'sent' : 'received'} audio-message`;
  
  const audioUrl = message.audioData;
  const duration = message.duration ? `${message.duration}s` : '';
  
  messageDiv.innerHTML = `
    ${!isSent ? `
      <img class="profile-pic" src="https://ui-avatars.com/api/?name=${encodeURIComponent(message.senderName || 'U')}&background=244576&color=fff">
    ` : ''}
    
    <div class="message-content">
      ${!isSent ? `<div class="user-info">${message.senderName}</div>` : ''}
      
      <audio class="audio-player" controls>
        <source src="${audioUrl}" type="audio/webm">
        Your browser does not support audio playback.
      </audio>
      
      <div class="audio-duration">${duration}</div>
      <div class="timestamp">${formatTimestamp(message.timestamp)}</div>
    </div>
  `;
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Update your displayMessage function to handle audio
function displayMessage(message, isSent) {
  if (message.type === 'audio') {
    displayAudioMessage(message, isSent);
  } else {
    // Your existing text message display code
  }
}

// Initialize when DOM loads
document.addEventListener('DOMContentLoaded', function() {
  initVoiceRecording();
});*/

  // Expose
  window.openChat = openChat;
  window.sendMessage = sendMessage;
  window.goBack = goBack;
  window.toggleSearch = toggleSearch;
  window.closeSearchIfOpen = closeSearchIfOpen;
  window.toggleMenu = toggleMenu;
  window.openModal = openModal;
  window.closeModal = closeModal;
  window.createChat = createChat;
  </script></body>
</html>